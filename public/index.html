<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Market Inference</title>
    </head>

    <body>
        <input type="text" id="ticker" name="ticker" placeholder="NVDA">
        <button onclick="search()">Search</button>

        <div id="direction1"></div>
        <div id="direction2"></div>
        <div id="direction3"></div>
        <div id="direction4"></div>

        <div style="display: flex; flex-direction: column;">
            <div id="chart"></div>
            <div id="answer"></div>
        </div>


        <script type="module">
            import { createChart, PriceScaleMode } from 'https://cdn.skypack.dev/lightweight-charts@4.1.0';

            function search() {
                // reset data before populating
                document.getElementById("chart").innerText = null;
                document.getElementById("answer").innerText = null;

                const input = document.getElementById('ticker');
                const inputValue = input.value.trim().toUpperCase() || input.placeholder;

                fetch(`/${inputValue}/datasets`)
                    .then(response => response.json())
                    .then(data => {
                        const chart = createChart(document.getElementById('chart'), {
                            width: 600,
                            height: 300,
                            leftPriceScale: {
                                visible: true,
                                mode: PriceScaleMode.Percentage,
                                borderVisible: false
                            },
                            rightPriceScale: {
                                visible: false
                            },
                            localization: {
                                percentageFormatter: (value) => {
                                    const percentage = value;
                                    const percentageString = percentage.toFixed(2);

                                    if (percentageString.endsWith('.00')) {
                                        return `${Math.round(percentage)}%`;
                                    } else {
                                        return `${percentageString}%`;
                                    }
                                },
                            },
                            timeScale: {
                                ticksVisible: true
                            },
                            grid: {
                                vertLines: {
                                    visible: false
                                }
                            }
                        });

                        const Market = chart.addLineSeries({
                            color: 'rgb(66, 133, 244)'
                        });
                        const Stock = chart.addLineSeries({
                            color: 'rgb(254, 199, 111)'
                        });

                        Market.setData(
                            data.marketData.bars.SPY.map(day => {
                                return {
                                    time: day.t,
                                    value: day.c
                                };
                            })
                        );
                        Stock.setData(
                            data.tickerData.bars[inputValue].map(day => {
                                return {
                                    time: day.t,
                                    value: day.c
                                };
                            })
                        );

                        chart.timeScale().fitContent();

                        fetch(`/${inputValue}/direction`)
                            .then(response => response.json())
                            .then(data => {
                                document.getElementById("direction1").innerText = "Low: " + data[inputValue].lowest_closing_price;
                                document.getElementById("direction2").innerText = data[inputValue].lowest_closing_price_date;
                                document.getElementById("direction3").innerText = data[inputValue].lowest_closing_price_date_minus_1_week;
                                document.getElementById("direction4").innerText = data[inputValue].lowest_closing_price_date_plus_1_week;
                            })
                            .catch(error => console.error('Error fetching data:', error));
                    })
                    .catch(error => console.error('Error fetching data:', error));
            }
            window.search = search;
        </script>
    </body>
</html>